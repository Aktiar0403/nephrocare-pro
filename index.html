<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NephroCare Pro</title>
  <style>
    form {
  display: flex;
  flex-direction: column;
}

form label {
  margin-top: 0.5rem;
  font-weight: bold;
}
@media print {
  body * {
    visibility: hidden;
  }

  #printable-prescription, #printable-prescription * {
    visibility: visible;
  }

  #printable-prescription {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    background-color: white;
    padding: 2rem;
    font-family: Arial, sans-serif;
  }

  #printable-prescription h2 {
    text-align: center;
    margin-bottom: 2rem;
  }

  #printable-prescription ul {
    list-style-type: none;
    padding-left: 0;
  }

  #printable-prescription li {
    margin-bottom: 0.5rem;
  }
}

form input,
form select,
form textarea {
  margin-top: 0.25rem;
  padding: 0.5rem;
  border-radius: 4px;
  border: 1px solid #ccc;
}
.input-ok {
  border: 2px solid #4caf50;
  background-color: #e8f5e9;
}

.input-warn {
  border: 2px solid #f44336;
  background-color: #ffebee;
}

.ref-range {
  display: block;
  font-size: 0.85rem;
  color: #555;
  margin-top: 0.25rem;
}

form small {
  font-size: 0.85rem;
  color: gray;
  margin-bottom: 0.5rem;
}

    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background-color: #f5f5f5;
    }

    h1 {
      text-align: center;
      color: #00796b;
    }

    .accordion-button {
      display: block;
      width: 100%;
      text-align: left;
      padding: 1rem;
      background-color: #00796b;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 5px;
      margin-top: 0.5rem;
      transition: background-color 0.2s ease;
    }

    .accordion-button:hover {
      background-color: #004d40;
    }

    .accordion-content {
      display: none;
      padding: 1rem;
      background-color: #e0f2f1;
      border-radius: 5px;
      margin-bottom: 0.5rem;
    }

    .accordion-content.show {
      display: block;
    }
  </style>
</head>
<body>
  <h1>NephroCare Pro</h1>

  <!-- Patient Profile Accordion -->
  <!-- Patient Profile Accordion -->
<button class="accordion-button">Patient Profile</button>
<div class="accordion-content">
  <form id="patient-profile-form">
    <label for="patient-name">Name:</label>
    <input type="text" id="patient-name" name="patient-name" placeholder="Enter name" required>

    <label for="patient-age">Age:</label>
    <input type="number" id="patient-age" name="patient-age" placeholder="Enter age" required>

    <label for="patient-gender">Gender:</label>
    <select id="patient-gender" name="patient-gender" required>
      <option value="">Select gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    </select>

    <label for="patient-location">Location:</label>
    <input type="text" id="patient-location" name="patient-location" placeholder="Enter location">
  </form>
</div>

  <!-- Medical History Accordion -->
  <!-- Medical History Accordion -->
<button class="accordion-button">Medical History</button>
<div class="accordion-content">
  <form id="medical-history-form">
    <label><input type="checkbox" id="diabetes" name="diabetes"> Diabetes</label>
    <input type="number" id="diabetes-duration" name="diabetes-duration" placeholder="Duration (years)">

    <label><input type="checkbox" id="hypertension" name="hypertension"> Hypertension</label>
    <input type="number" id="hypertension-duration" name="hypertension-duration" placeholder="Duration (years)">

    <label><input type="checkbox" id="nsaid-use" name="nsaid-use"> NSAID Use</label>
    <label><input type="checkbox" id="past-stone-disease" name="past-stone-disease"> Past Stone Disease</label>
    <label><input type="checkbox" id="family-ckd" name="family-ckd"> Family History of CKD</label>
    <label><input type="checkbox" id="tb" name="tb"> TB</label>
    <label><input type="checkbox" id="hiv" name="hiv"> HIV</label>
    <label><input type="checkbox" id="hepatitis" name="hepatitis"> Hepatitis</label>
  </form>
</div>

<!-- Symptoms Accordion -->
<!-- Symptoms Accordion -->
<button class="accordion-button">Symptoms</button>
<div class="accordion-content">
  <form id="symptoms-form">
    <label><input type="checkbox" id="edema" name="edema"> Edema (Swelling)</label>
    <label><input type="checkbox" id="fatigue" name="fatigue"> Fatigue</label>
    <label><input type="checkbox" id="nausea" name="nausea"> Nausea</label>
    <label><input type="checkbox" id="vomiting" name="vomiting"> Vomiting</label>
    <label><input type="checkbox" id="breathlessness" name="breathlessness"> Breathlessness</label>
    <label><input type="checkbox" id="decreased-urine-output" name="decreased-urine-output"> Decreased Urine Output</label>
    <label><input type="checkbox" id="flank-pain" name="flank-pain"> Flank Pain</label>
    <label><input type="checkbox" id="hematuria" name="hematuria"> Hematuria (Blood in urine)</label>
  </form>
</div>
<!-- Vital Signs Accordion -->
<button class="accordion-button">Vital Signs</button>
<div class="accordion-content">
  <form id="vital-signs-form">
    <label for="sbp">Systolic BP (mmHg):</label>
    <input type="number" id="sbp" name="sbp" placeholder="Enter SBP">

    <label for="dbp">Diastolic BP (mmHg):</label>
    <input type="number" id="dbp" name="dbp" placeholder="Enter DBP">

    <label for="weight">Weight (kg):</label>
    <input type="number" id="weight" name="weight" placeholder="Enter weight">

    <label for="volume-status">Volume Status:</label>
    <select id="volume-status" name="volume-status">
      <option value="">Select status</option>
      <option value="Normal">Normal</option>
      <option value="Hypervolemic">Hypervolemic (Fluid overload)</option>
      <option value="Hypovolemic">Hypovolemic (Dehydrated)</option>
    </select>
  </form>
</div>
<!-- Blood Tests Accordion -->
<button class="accordion-button">Blood Tests</button>
<div class="accordion-content">
  <form id="blood-tests-form">
    <label for="creatinine">Creatinine (mg/dL):</label>
    <input type="number" step="0.01" id="creatinine" name="creatinine">

    <label for="egfr">eGFR (mL/min):</label>
    <input type="number" id="egfr" name="egfr">

    <label for="urea">Urea (mg/dL):</label>
    <input type="number" id="urea" name="urea">

    <label for="potassium">Potassium (mEq/L):</label>
    <input type="number" step="0.01" id="potassium" name="potassium">

    <label for="sodium">Sodium (mEq/L):</label>
    <input type="number" id="sodium" name="sodium">

    <label for="calcium">Calcium (mg/dL):</label>
    <input type="number" step="0.01" id="calcium" name="calcium">

    <label for="phosphate">Phosphate (mg/dL):</label>
    <input type="number" step="0.01" id="phosphate" name="phosphate">

    <label for="bicarbonate">Bicarbonate (mEq/L):</label>
    <input type="number" step="0.1" id="bicarbonate" name="bicarbonate">

    <label for="hemoglobin">Hemoglobin (g/dL):</label>
    <input type="number" step="0.1" id="hemoglobin" name="hemoglobin">

    <label for="albumin">Albumin (g/dL):</label>
    <input type="number" step="0.1" id="albumin" name="albumin">

    <label for="pth">PTH (pg/mL):</label>
    <input type="number" id="pth" name="pth">
  </form>
</div>
<!-- Urine Tests Accordion -->
<button class="accordion-button">Urine Tests</button>
<div class="accordion-content">
  <form id="urine-tests-form">
    <label for="urinalysis-protein">Urinalysis Protein:</label>
    <input type="text" id="urinalysis-protein" name="urinalysis-protein">

    <label for="urinalysis-blood">Urinalysis Blood:</label>
    <input type="text" id="urinalysis-blood" name="urinalysis-blood">

    <label for="spot-protein-creatinine">Spot Protein/Creatinine Ratio (mg/g):</label>
    <input type="number" id="spot-protein-creatinine" name="spot-protein-creatinine">

    <label for="acr">Albumin/Creatinine Ratio (mg/g):</label>
    <input type="number" id="acr" name="acr">

    <label for="urine-protein-24h">24-hour Protein (g/day):</label>
    <input type="number" step="0.01" id="urine-protein-24h" name="urine-protein-24h">
  </form>
</div>
<!-- Ultrasound Report Accordion -->
<button class="accordion-button">Ultrasound Report</button>
<div class="accordion-content">
  <form id="ultrasound-report-form">
    <label for="kidney-size">Kidney Size:</label>
    <select id="kidney-size" name="kidney-size">
      <option value="">Select</option>
      <option value="Normal">Normal</option>
      <option value="Increased">Increased</option>
      <option value="Decreased">Decreased</option>
      <option value="Asymmetrical">Asymmetrical</option>
    </select>

    <label for="echogenicity">Cortical Echogenicity:</label>
    <select id="echogenicity" name="echogenicity">
      <option value="">Select</option>
      <option value="Normal">Normal</option>
      <option value="Mildly increased">Mildly increased</option>
      <option value="Markedly increased">Markedly increased</option>
    </select>

    <label for="parenchymal-thickness">Parenchymal Thickness:</label>
    <select id="parenchymal-thickness" name="parenchymal-thickness">
      <option value="">Select</option>
      <option value="Normal">Normal</option>
      <option value="Reduced">Reduced</option>
    </select>

    <label for="hydronephrosis">Hydronephrosis:</label>
    <select id="hydronephrosis" name="hydronephrosis">
      <option value="">Select</option>
      <option value="None">None</option>
      <option value="Mild">Mild</option>
      <option value="Moderate">Moderate</option>
      <option value="Severe">Severe</option>
    </select>

    <label for="stones">Stones:</label>
    <select id="stones" name="stones">
      <option value="">Select</option>
      <option value="None">None</option>
      <option value="Single">Single</option>
      <option value="Multiple">Multiple</option>
      <option value="Bilateral">Bilateral</option>
    </select>

    <label for="cysts">Cysts:</label>
    <select id="cysts" name="cysts">
      <option value="">Select</option>
      <option value="None">None</option>
      <option value="Single">Single</option>
      <option value="Multiple unilateral">Multiple unilateral</option>
      <option value="Multiple bilateral">Multiple bilateral</option>
    </select>

    <fieldset>
      <legend>Other Findings:</legend>
      <label><input type="checkbox" name="other-findings" value="Cortical scarring"> Cortical scarring</label>
      <label><input type="checkbox" name="other-findings" value="Poor corticomedullary differentiation"> Poor corticomedullary differentiation</label>
      <label><input type="checkbox" name="other-findings" value="Perinephric collection"> Perinephric collection</label>
    </fieldset>
  </form>
</div>
<!-- AI Diagnosis Accordion -->
<button class="accordion-button">AI Diagnosis</button>
<div class="accordion-content">
  <div id="ai-diagnosis-section">
    <button id="generate-diagnosis">Generate Diagnosis</button>

    <h3>Doctor-Level Interpretation</h3>
    <textarea id="doctor-diagnosis" readonly placeholder="Diagnosis will appear here"></textarea>

    <h3>Patient-Friendly Explanation</h3>
    <textarea id="patient-diagnosis" readonly placeholder="Patient explanation will appear here"></textarea>
  </div>
  <button type="button" id="save-visit">üíæ Save This Visit</button>
</div>
<!-- Prescription Accordion -->
<button class="accordion-button">Prescription</button>
<div class="accordion-content">
  <form id="prescription-form">
    <label for="med-name">Medicine Name:</label>
    <input type="text" id="med-name" name="med-name" placeholder="e.g. Ramipril">

    <label for="dose">Dose:</label>
    <input type="text" id="dose" name="dose" placeholder="e.g. 5mg daily">

    <label for="notes">Doctor Notes:</label>
    <textarea id="notes" name="notes" placeholder="Instructions for doctor"></textarea>

    <label for="patient-instructions">Patient Instructions:</label>
    <textarea id="patient-instructions" name="patient-instructions" placeholder="Simple words for patient"></textarea>
  </form>
  <button type="button" id="print-prescription">üñ®Ô∏è Print Prescription</button>

</div>
<!-- Saved Records Accordion -->
<button class="accordion-button">Saved Records</button>
<div class="accordion-content">
  <div id="saved-records-section">
    <p>No saved records yet.</p>
    <ul id="saved-records-list"></ul>
    <div id="visit-details"></div>
    <button id="export-button" style="display:none;">üìã Export This Visit as Text</button>
    <textarea id="export-text" readonly style="display:none; width:100%; height:200px; margin-top:1rem;"></textarea>
  </div>
</div>
<button class="accordion-button">Settings</button>
<div class="accordion-content">
  <div id="settings-section">
    <h3>Editable Diagnosis Rules</h3>
    <p>Below are the rules the app uses to suggest diagnoses. You can edit them, but you must enter a reason for any change (for audit trail).</p>
    
    <form id="rules-form">
      <label for="test-name">Test Name:</label>
      <input type="text" id="test-name" name="test-name" placeholder="e.g. eGFR">

      <label for="operator">Operator:</label>
      <select id="operator" name="operator">
        <option value="">Select</option>
        <option value="<">&lt;</option>
        <option value=">">&gt;</option>
        <option value="=">=</option>
      </select>

      <label for="threshold">Threshold:</label>
      <input type="number" id="threshold" name="threshold" placeholder="e.g. 60">

      <label for="suggestion">Suggestion Text:</label>
      <input type="text" id="suggestion" name="suggestion" placeholder="e.g. CKD Stage 3+">

      <label for="reason">Reason for Change:</label>
      <textarea id="reason" name="reason" placeholder="e.g. Local guidelines differ" required></textarea>

      <button type="button" id="save-rule">Save Rule</button>
    </form>

    <h4>Existing Rules</h4>
    <ul id="rules-list">
      <li>eGFR < 60 ‚Üí CKD Stage 3+ (Default rule)</li>
      <li>ACR > 300 ‚Üí Nephrotic range proteinuria (Default rule)</li>
    </ul>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
const referenceRanges = {
  creatinine: { min: 0.6, max: 1.3 },
  egfr: { min: 60, max: 120 },
  urea: { min: 10, max: 50 },
  potassium: { min: 3.5, max: 5.2 },
  sodium: { min: 135, max: 145 },
  calcium: { min: 8.5, max: 10.5 },
  phosphate: { min: 2.5, max: 4.5 },
  hemoglobin: { min: 12, max: 16 },
  albumin: { min: 3.5, max: 5.5 },
  sbp: { min: 90, max: 140 },
  dbp: { min: 60, max: 90 },
  weight: { min: 30, max: 200 }
  // Add more as needed
};
let medicines = [];

fetch('/medicines.json')
  .then(response => response.json())
  .then(data => {
    medicines = data;
    console.log('Medicines loaded:', medicines);
  })
  .catch(error => {
    console.error('Error loading medicines:', error);
  });




  // ‚úÖ Accordion Toggle
  const buttons = document.querySelectorAll('.accordion-button');
  buttons.forEach(button => {
    button.addEventListener('click', () => {
      const content = button.nextElementSibling;
      if (!content) return;
      content.classList.toggle('show');
    });
  });

  // ‚úÖ Saved Records Setup
  const saveButton = document.getElementById('save-visit');
  const recordsList = document.getElementById('saved-records-list');
  const visitDetails = document.getElementById('visit-details');

  let visits = JSON.parse(localStorage.getItem('visits')) || [];
  renderVisitList();

  let serialCounter = parseInt(localStorage.getItem('visitSerialCounter')) || 1;
  let diagnosisRules = JSON.parse(localStorage.getItem('diagnosisRules')) || [];
renderRulesList();
const defaultDiagnosisRules = [
  // Simple rules
  { type: "simple", test: "egfr", operator: "<", threshold: 90, suggestion: "CKD Stage 2", reason: "KDIGO guidelines" },
  { type: "simple", test: "egfr", operator: "<", threshold: 60, suggestion: "CKD Stage 3", reason: "Moderate reduction" },
  { type: "simple", test: "egfr", operator: "<", threshold: 30, suggestion: "CKD Stage 4", reason: "Severe reduction" },
  { type: "simple", test: "egfr", operator: "<", threshold: 15, suggestion: "CKD Stage 5 (ESRD)", reason: "Kidney failure" },
  { type: "simple", test: "acr", operator: ">", threshold: 30, suggestion: "Microalbuminuria", reason: "Early kidney damage" },
  { type: "simple", test: "acr", operator: ">", threshold: 300, suggestion: "Nephrotic-range proteinuria", reason: "Severe glomerular disease" },

  // Advanced rule
  {
    type: "multi",
    conditions: [
      { section: "blood", field: "egfr", operator: "<", value: 60 },
      { section: "urine", field: "acr", operator: ">", value: 300 }
    ],
    suggestion: "Proteinuric CKD",
    reason: "Combined eGFR reduction and albuminuria."
  },

  // Complex compound rule
  {
    type: "compound",
    conditions: [
      { section: "history", field: "diabetes", operator: "==", value: true },
      { section: "blood", field: "egfr", operator: "<", value: 60 },
      { section: "urine", field: "acr", operator: ">", value: 300 },
      { section: "ultrasound", field: "echogenicity", operator: "in", value: ["Mildly increased", "Markedly increased"] }
    ],
    suggestion: "Likely Diabetic Nephropathy",
    reason: "Combines history, labs, USG."
  },
  {
    type: "compound",
    conditions: [
      { section: "history", field: "hypertension", operator: "==", value: true },
      { section: "blood", field: "egfr", operator: "<", value: 60 },
      { section: "urine", field: "acr", operator: "<", value: 300 },
      { section: "ultrasound", field: "kidneySize", operator: "==", value: "Decreased" },
      { section: "ultrasound", field: "echogenicity", operator: "==", value: "Mildly increased" }
    ],
    suggestion: "Possible Hypertensive Nephrosclerosis",
    reason: "Classic imaging + lab pattern."
    
  }
  
];

if (!diagnosisRules.length) {
  diagnosisRules = defaultDiagnosisRules;
  localStorage.setItem('diagnosisRules', JSON.stringify(diagnosisRules));
}


document.getElementById('save-rule').addEventListener('click', () => {
  const testName = document.getElementById('test-name').value.trim();
  const operator = document.getElementById('operator').value.trim();
  const threshold = document.getElementById('threshold').value.trim();
  const suggestion = document.getElementById('suggestion').value.trim();
  const reason = document.getElementById('reason').value.trim();

  if (!testName || !operator || !threshold || !suggestion || !reason) {
    alert('All fields including Reason are required!');
    return;
  }

  const newRule = {
    test: testName,
    operator,
    threshold: parseFloat(threshold),
    suggestion,
    reason
  };

  diagnosisRules.push(newRule);
  localStorage.setItem('diagnosisRules', JSON.stringify(diagnosisRules));
  renderRulesList();

  alert('Rule saved successfully!');
  
  // Clear form
  document.getElementById('test-name').value = '';
  document.getElementById('operator').value = '';
  document.getElementById('threshold').value = '';
  document.getElementById('suggestion').value = '';
  document.getElementById('reason').value = '';
});
function setupReferenceHelpers() {
  Object.entries(referenceRanges).forEach(([id, range]) => {
    const input = document.getElementById(id);
    if (input) {
      // Add reference range below input
      const helper = document.createElement('small');
      helper.className = 'ref-range';
      helper.textContent = `Reference: ${range.min} ‚Äì ${range.max}`;
      input.parentNode.insertBefore(helper, input.nextSibling);

      // Listen for input to color-code
      input.addEventListener('input', () => {
        const val = parseFloat(input.value);
        if (isNaN(val)) {
          input.classList.remove('input-ok', 'input-warn');
          return;
        }
        if (val >= range.min && val <= range.max) {
          input.classList.add('input-ok');
          input.classList.remove('input-warn');
        } else {
          input.classList.add('input-warn');
          input.classList.remove('input-ok');
        }
      });
    }
  });
}

function renderRulesList() {
  const rulesList = document.getElementById('rules-list');
  rulesList.innerHTML = '';

  if (diagnosisRules.length === 0) {
    rulesList.innerHTML = '<li>No custom rules added yet.</li>';
    return;
  }

  diagnosisRules.forEach((rule, index) => {
    const li = document.createElement('li');
    li.innerHTML = `
      ${rule.test} ${rule.operator} ${rule.threshold} ‚Üí ${rule.suggestion}
      <br><small>Reason: ${rule.reason}</small>
      <button style="margin-left:1rem; background-color:#e53935; color:white; border:none; padding:0.25rem 0.5rem; border-radius:4px; cursor:pointer;" data-index="${index}">üóëÔ∏è Delete</button>
    `;

    li.querySelector('button').addEventListener('click', () => {
      if (confirm('Are you sure you want to delete this rule?')) {
        diagnosisRules.splice(index, 1);
        localStorage.setItem('diagnosisRules', JSON.stringify(diagnosisRules));
        renderRulesList();
      }
    });

    rulesList.appendChild(li);
  });
}

  // ‚úÖ Save button listener
  saveButton.addEventListener('click', () => {
    const visitData = collectVisitData();
    visits.push(visitData);
    serialCounter++;
    localStorage.setItem('visitSerialCounter', serialCounter);
    localStorage.setItem('visits', JSON.stringify(visits));
    renderVisitList();
    alert('Visit saved!');
  });

  // ‚úÖ Function 1: collectVisitData
  function collectVisitData() {
    const profileForm = document.getElementById('patient-profile-form');
    const medicalForm = document.getElementById('medical-history-form');
    const symptomsForm = document.getElementById('symptoms-form');
    const vitalsForm = document.getElementById('vital-signs-form');
    const bloodForm = document.getElementById('blood-tests-form');
    const urineForm = document.getElementById('urine-tests-form');
    const ultrasoundForm = document.getElementById('ultrasound-report-form');
    const prescriptionForm = document.getElementById('prescription-form');
    const doctorDiagnosis = document.getElementById('doctor-diagnosis').value;
    const patientDiagnosis = document.getElementById('patient-diagnosis').value;

    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = String(today.getFullYear()).slice(-2);
    const datePart = `${day}${month}${year}`;
    const serialNumber = String(serialCounter).padStart(4, '0');
    const visitId = `${datePart}-${serialNumber}`;

    return {
      id: visitId,
      date: datePart,
      serial: serialNumber,
      profile: Object.fromEntries(new FormData(profileForm)),
      medical: Object.fromEntries(new FormData(medicalForm)),
      symptoms: Object.fromEntries(new FormData(symptomsForm)),
      vitals: Object.fromEntries(new FormData(vitalsForm)),
      blood: Object.fromEntries(new FormData(bloodForm)),
      urine: Object.fromEntries(new FormData(urineForm)),
      ultrasound: Object.fromEntries(new FormData(ultrasoundForm)),
      prescription: Object.fromEntries(new FormData(prescriptionForm)),
      diagnosis: {
        doctor: doctorDiagnosis,
        patient: patientDiagnosis
      }
    };
  }
  function renderTextFields(data) {
  return Object.entries(data)
    .map(([key, value]) => `- ${key}: ${value ? value : 'Not provided'}`)
    .join('\n') + '\n';
}

  function generateExportText(visit) {
  let text = `üÜî Visit ID: ${visit.id}\n\n`;

  text += `üßæ Patient Profile\n`;
  text += renderTextFields(visit.profile);

  text += `\nüóÇÔ∏è Medical History\n`;
  text += renderTextFields(visit.medical);

  text += `\nü©π Symptoms\n`;
  text += renderTextFields(visit.symptoms);

  text += `\nüíì Vital Signs\n`;
  text += renderTextFields(visit.vitals);

  text += `\nü©∏ Blood Tests\n`;
  text += renderTextFields(visit.blood);

  text += `\nüíß Urine Tests\n`;
  text += renderTextFields(visit.urine);

  text += `\nüñºÔ∏è Ultrasound Report\n`;
  text += renderTextFields(visit.ultrasound);

  text += `\nüíä Prescription\n`;
  text += renderTextFields(visit.prescription);

  text += `\nüß≠ AI Diagnosis\n`;
  text += `Doctor-level: ${visit.diagnosis.doctor ? visit.diagnosis.doctor : 'Not provided'}\n`;
  text += `Patient-friendly: ${visit.diagnosis.patient ? visit.diagnosis.patient : 'Not provided'}\n`;

  return text;
}

  // ‚úÖ Function 2: renderFieldsReference
  function renderFields(data) {
  return Object.entries(data)
    .map(([key, value]) => {
      if (!value) value = 'Not provided';

      let style = '';
      if (referenceRanges[key]) {
        const min = referenceRanges[key].min;
        const max = referenceRanges[key].max;
        const num = parseFloat(value);

        if (!isNaN(num)) {
          if (num < min) style = 'color: orange;';   // below range
          else if (num > max) style = 'color: red;'; // above range
          else style = 'color: green;';              // normal
        }
      }

      return `<li><strong>${key}:</strong> <span style="${style}">${value}</span></li>`;
    })
    .join('');
}


  // ‚úÖ Function 3: renderVisitList
  function renderVisitList() {
    recordsList.innerHTML = '';
    if (visits.length === 0) {
      recordsList.innerHTML = '<p>No saved records yet.</p>';
      return;
    }

    visits.forEach((visit, index) => {
      const li = document.createElement('li');

      const label = document.createElement('span');
      label.textContent = visit.id || `Visit ${index + 1}`;
      label.style.cursor = 'pointer';
      label.style.marginRight = '1rem';
      label.addEventListener('click', () => {
        displayVisitDetails(visit);
      });

      const deleteButton = document.createElement('button');
      deleteButton.textContent = 'üóëÔ∏è Delete';
      deleteButton.style.marginLeft = '1rem';
      deleteButton.style.backgroundColor = '#e53935';
      deleteButton.style.color = 'white';
      deleteButton.style.border = 'none';
      deleteButton.style.padding = '0.25rem 0.5rem';
      deleteButton.style.borderRadius = '4px';
      deleteButton.style.cursor = 'pointer';

      deleteButton.addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this visit?')) {
          visits.splice(index, 1);
          localStorage.setItem('visits', JSON.stringify(visits));
          renderVisitList();
          visitDetails.innerHTML = '';
        }
      });

      li.appendChild(label);
      li.appendChild(deleteButton);
      recordsList.appendChild(li);
    });
  }

  function displayVisitDetails(visit) {
  visitDetails.innerHTML = `
    <h4>üÜî Visit ID: ${visit.id}</h4>
    <h4>üßæ Patient Profile</h4>
    <ul>
      ${renderFields(visit.profile)}
    </ul>
    <h4>üóÇÔ∏è Medical History</h4>
    <ul>
      ${renderFields(visit.medical)}
    </ul>
    <h4>ü©π Symptoms</h4>
    <ul>
      ${renderFields(visit.symptoms)}
    </ul>
    <h4>üíì Vital Signs</h4>
    <ul>
      ${renderFields(visit.vitals)}
    </ul>
    <h4>ü©∏ Blood Tests</h4>
    <ul>
      ${renderFields(visit.blood)}
    </ul>
    <h4>üíß Urine Tests</h4>
    <ul>
      ${renderFields(visit.urine)}
    </ul>
    <h4>üñºÔ∏è Ultrasound Report</h4>
    <ul>
      ${renderFields(visit.ultrasound)}
    </ul>
    <h4>üíä Prescription</h4>
    <ul>
      ${renderFields(visit.prescription)}
    </ul>
    <h4>üß≠ AI Diagnosis</h4>
    <p><strong>Doctor-level:</strong> ${visit.diagnosis.doctor ? visit.diagnosis.doctor : 'Not provided'}</p>
    <p><strong>Patient-friendly:</strong> ${visit.diagnosis.patient ? visit.diagnosis.patient : 'Not provided'}</p>
  `;

  document.getElementById('export-button').style.display = 'block';
  document.getElementById('export-button').onclick = () => {
    const exportText = generateExportText(visit);
    document.getElementById('export-text').value = exportText;
    document.getElementById('export-text').style.display = 'block';
  };
}
function evaluateCondition(cond, visit) {
  const sectionData = visit[cond.section];
  if (!sectionData) return false;

  const val = sectionData[cond.field];
  if (val === undefined) return false;

  switch (cond.operator) {
    case "<": return parseFloat(val) < cond.value;
    case ">": return parseFloat(val) > cond.value;
    case "==": return val == cond.value;
    case "in": return cond.value.includes(val);
    default: return false;
  }
}

function evaluateRule(rule, visit) {
  if (rule.type === "simple") {
    return evaluateCondition({
      section: "blood",
      field: rule.test,
      operator: rule.operator,
      value: rule.threshold
    }, visit);
  }

  if (rule.type === "multi" || rule.type === "compound") {
    return rule.conditions.every(cond => evaluateCondition(cond, visit));
  }

  return false;
}

function generateDiagnosisText(visit) {
  const matches = [];
  for (const rule of diagnosisRules) {
    if (evaluateRule(rule, visit)) {
      matches.push(`- ${rule.suggestion} (Reason: ${rule.reason})`);
    }
  }
  return matches.length ? matches.join('\n') : "No diagnosis suggestions matched.";
}

document.getElementById('generate-diagnosis').addEventListener('click', () => {
  const visitData = collectVisitData();
  const diagnosisText = generateDiagnosisText(visitData);

  document.getElementById('doctor-diagnosis').value = diagnosisText;
  document.getElementById('patient-diagnosis').value = diagnosisText;

  // Auto-suggest medicines
  // Auto-suggest medicines
const meds = getMedicinesForDiagnosis(diagnosisText);

let medNames;
if (meds.length === 0) {
  medNames = "No worries, you are Healthy!";
} else {
  medNames = meds.map(m => `${m.name} (${m.type})`).join('\n');
}

document.getElementById('med-name').value = medNames;
document.getElementById('dose').value = '';
document.getElementById('notes').value = '';
document.getElementById('patient-instructions').value = '';

});
function getMedicinesForDiagnosis(diagnosisText) {
  const lowerDiag = diagnosisText.toLowerCase();
  return medicines.filter(med =>
    med.indications.some(indication =>
      lowerDiag.includes(indication.toLowerCase()) ||
      indication.toLowerCase().includes(lowerDiag)
    )
  );
  if (medNames.trim() === '') {
  document.getElementById('med-name').value = '‚ö†Ô∏è No suggested medicines found. Please add manually.';
}

}


  
  return suggestions;


setupReferenceHelpers();
document.getElementById('generate-diagnosis').addEventListener('click', () => {
  const visitData = collectVisitData();
  const diagnosisText = generateDiagnosisText(visitData).trim();

  // If no diagnosis found, show fallback
  if (!diagnosisText || diagnosisText === "No diagnosis suggestions matched.") {
    document.getElementById('doctor-diagnosis').value = "No significant diagnosis. Stay healthy!";
    document.getElementById('patient-diagnosis').value = "No worries, you are Healthy!";
    document.getElementById('med-name').value = "No medicines needed!";
    document.getElementById('dose').value = '';
    document.getElementById('notes').value = '';
    document.getElementById('patient-instructions').value = '';
    return;
  }

  // Fill diagnosis fields
  document.getElementById('doctor-diagnosis').value = diagnosisText;
  document.getElementById('patient-diagnosis').value = diagnosisText;

  // Suggest medicines
  const meds = getMedicinesForDiagnosis(diagnosisText);
  let medNames;
  if (meds.length === 0) {
    medNames = "No worries, you are Healthy!";
  } else {
    medNames = meds.map(m => `${m.name} (${m.type})`).join('\n');
  }

  document.getElementById('med-name').value = medNames;
  document.getElementById('dose').value = '';
  document.getElementById('notes').value = '';
  document.getElementById('patient-instructions').value = '';
});

});


</script> 
<div id="printable-prescription" style="display:none;"></div>

</body>
</html>
